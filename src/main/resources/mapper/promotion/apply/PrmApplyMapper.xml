<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.plateer.ec1.promotion.apply.mapper.PrmApplyMapper">

    <resultMap id="ApplicableCupMap" type="com.plateer.ec1.promotion.apply.vo.PrmAplyVO">
        <id property="goodsItemNo" column="goods_item_no"/>
        <association property="product" autoMapping="true"/>
        <collection property="applicableCupVOList" ofType="com.plateer.ec1.promotion.apply.vo.ApplicableCupVO" autoMapping="true">
            <id property="cpnIssNo" column="cpn_iss_no"/>
        </collection>
    </resultMap>

    <sql id="prm_apy_info">
        <include refid="com.plateer.ec1.promotion.com.mapper.CupInfoMapper.sql_cupInfo" />
        , prd as(
        <foreach collection="productList" item="product" separator="union all">
            select  #{product.goodsNo} as goods_no,
            #{product.itemNo} as item_no,
            #{product.orrAt} as orr_at
        </foreach>
        ), aply as (
            select
                prd.*,
                apy.prm_no
            from cc_prm_aply_tgt apy inner join prd on apy.aply_tgt_no = prd.goods_no
        )
    </sql>

    <select id="getApplicablePrmList" resultMap="ApplicableCupMap">
        <include refid="prm_apy_info" />
        select
            concat(aply.goods_no, '', aply.item_no) as goods_item_no,
            aply.goods_no,
            aply.item_no,
            ci.prm_no,
            ci.prm_nm,
            ci.dc_ccd,
            ci.dc_val,
            ci.min_pur_amt,
            ci.max_dc_amt,
            <choose>
                <when test ="@com.plateer.ec1.promotion.enums.PRM0001Code@COUPON.getCode().equals(cpnKindCd)">
                    case when ci.prm_priod_ccd = '10' then ci.prm_end_dt
                    else iss.sys_mod_dtime + ci.prm_std_dd * interval '1 day'
                    end prm_end_dt
                </when>
                <otherwise>
                    ci.prm_end_dt
                </otherwise>
            </choose>
        from cup_info ci inner join aply on ci.prm_no = aply.prm_no
            <if test = "@com.plateer.ec1.promotion.enums.PRM0001Code@COUPON.getCode().equals(cpnKindCd)">
                        inner join cc_cpn_issue iss on aply.prm_no = iss.prm_no and iss.mbr_no = #{mbrNo}
            </if>
        where 1 = 1
            and ci.use_yn = 'Y'
            and now() <![CDATA[<]]> ci.prm_end_dt
            and ci.prm_kind_cd = #{prmKindCd}
            and ci.min_pur_amt <![CDATA[<]]> aply.orr_at
            <if test="@com.plateer.ec1.promotion.enums.PRM0001Code@COUPON.getCode().equals(cpnKindCd)">
                and ci.cpn_kind_cd =  #{cpnKindCd}
                and iss.cpn_use_dt is null
            </if>
    </select>

</mapper>