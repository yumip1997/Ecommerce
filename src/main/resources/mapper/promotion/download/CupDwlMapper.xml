<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.plateer.ec1.promotion.download.mapper.CupDwlMapper">
    <sql id="sql_getCupIssBasicInfo">
        select
            prm.prm_no,
            prm.prm_nm,
            prm.use_yn,
            to_timestamp(cup.dwl_avl_end_dd, 'YYYYMMDD') as dwl_avl_end_dd,
            cup.dwl_psb_cnt,
            cup.psn_dwl_psb_cnt,
            (select count(*) from cc_cpn_issue where prm_no = #{prmNo}) as total_cnt,
            (select count(*) from cc_cpn_issue where prm_no = #{prmNo} and mbr_no = #{mbrNo}) as mbr_cnt
        from cc_prm_base as prm inner join cc_cpn_base as cup on prm.prm_no = cup.prm_no
    </sql>

    <select id="getCupDwlInfo" resultType="com.plateer.ec1.promotion.download.vo.CupInfoVO">
        <include refid="sql_getCupIssBasicInfo"></include>
        where prm.prm_no = #{prmNo}
    </select>

    <select id="getOfflineCupInfo" resultType="com.plateer.ec1.promotion.download.vo.CupInfoVO">
        select basic.*,
        iss.cup_iss_no,
        from (
            <include refid="sql_getCupIssBasicInfo"></include> as basic
            inner join cc_cpn_issue as iss on basic.prm_no = iss.prm_no
        )
        where iss.cpn_cert_no = #{cpnCertNo}
    </select>

</mapper>